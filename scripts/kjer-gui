#!/bin/bash
# Kjer GUI Launcher for Linux
# Launches the Electron-based GUI application

# Resolve real script location even when called through a symlink
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
DESKTOP_DIR="$SCRIPT_DIR/../desktop"
KJER_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Resolve Electron binary: local install preferred, fall back to global
LOCAL_ELECTRON="$DESKTOP_DIR/node_modules/.bin/electron"
if [ -x "$LOCAL_ELECTRON" ]; then
    ELECTRON_BIN="$LOCAL_ELECTRON"
elif command -v electron &> /dev/null; then
    ELECTRON_BIN="$(command -v electron)"
else
    echo "Error: Electron is not installed."
    echo ""
    echo "Run the dependency installer:"
    echo "  bash $KJER_ROOT/installer/kjer-install.sh"
    echo ""
    echo "Or install manually:"
    echo "  cd $DESKTOP_DIR && npm install"
    exit 1
fi

# Check if desktop directory exists
if [ ! -d "$DESKTOP_DIR" ]; then
    echo "Error: Kjer desktop directory not found at $DESKTOP_DIR"
    exit 1
fi

# Determine sandbox flags.
# If chrome-sandbox is not owned by root with SUID bit (mode 4755), pass
# --no-sandbox so Electron can still launch without FATAL sandbox error.
SANDBOX="$DESKTOP_DIR/node_modules/electron/dist/chrome-sandbox"
SANDBOX_FLAGS=""
if [ -f "$SANDBOX" ]; then
    SANDBOX_OWNER="$(stat -c '%U' "$SANDBOX" 2>/dev/null)"
    SANDBOX_MODE="$(stat -c '%a' "$SANDBOX" 2>/dev/null)"
    if [ "$SANDBOX_OWNER" != "root" ] || [ "$SANDBOX_MODE" != "4755" ]; then
        SANDBOX_FLAGS="--no-sandbox"
    fi
else
    # Binary missing entirely â€” skip sandbox
    SANDBOX_FLAGS="--no-sandbox"
fi

# Launch Electron GUI
cd "$DESKTOP_DIR" && "$ELECTRON_BIN" . $SANDBOX_FLAGS "$@"
